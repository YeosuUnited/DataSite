<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메인 페이지</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            min-width: 800px; /* 테이블 최소 너비 설정 */
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            text-align: left; /* 왼쪽 정렬 */
            color: blue; /* 파란색 텍스트 */
        }
        .table-container {
            overflow-x: auto; /* 테이블 슬라이딩 기능 */
        }
        .top-label {
            color: blue; /* TOP 파란색 */
        }
        .top-number {
            color: red; /* 5 빨간색 */
        }
    </style>
    <script>
        let cachedData = {};
        let lastUpdated = null;

        // 시간을 형식화하는 함수
        function formatTime(date) {
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
        }

        // 데이터 갱신 및 캐싱하는 함수
        async function fetchData() {
            try {
                document.getElementById('status').innerText = '데이터를 불러오는 중...';
                
                const [playerRecordResponse, matchRecordResponse, playerDataResponse] = await Promise.all([
                    fetch('https://script.google.com/macros/s/AKfycbwr4inHtj2P_4NNIVBJCiPFWESOfa_pSKEdSJHjLIes0K_FjL25CYBky3VUsyOUi-9e/exec?sheet=PlayerRecord'),
                    fetch('https://script.google.com/macros/s/AKfycbwr4inHtj2P_4NNIVBJCiPFWESOfa_pSKEdSJHjLIes0K_FjL25CYBky3VUsyOUi-9e/exec?sheet=MatchRecord'),
                    fetch('https://script.google.com/macros/s/AKfycbwr4inHtj2P_4NNIVBJCiPFWESOfa_pSKEdSJHjLIes0K_FjL25CYBky3VUsyOUi-9e/exec?sheet=PlayerData')
                ]);
                
                if (!playerRecordResponse.ok || !matchRecordResponse.ok || !playerDataResponse.ok) {
                    throw new Error('데이터 응답 실패');
                }
                
                const [playerRecord, matchRecord, playerData] = await Promise.all([
                    playerRecordResponse.json(),
                    matchRecordResponse.json(),
                    playerDataResponse.json()
                ]);
                
                cachedData = { playerRecord, matchRecord, playerData };
                
                lastUpdated = new Date().getTime();
                localStorage.setItem('cachedData', JSON.stringify(cachedData));
                localStorage.setItem('lastUpdated', lastUpdated);
                
                document.getElementById('status').innerText = '데이터가 성공적으로 업데이트되었습니다.';
                updateTimeInfo();
                createTable(playerRecord);
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('status').innerText = '데이터를 불러오는 중 오류가 발생했습니다.';
            }
        }

        // 테이블을 동적으로 생성하는 함수
        function createTable(playerRecord) {
            const currentYear = new Date().getFullYear(); // 서버 시간 기준으로 현재 연도 가져옴
            const thisYearData = playerRecord.filter(player => player['년도'] === currentYear); // 올해 데이터만 필터링
        
            const topGoals = getSortedPlayers(thisYearData, '득점').slice(0, 5); // 5명까지 표시
            const topAssists = getSortedPlayers(thisYearData, '도움').slice(0, 5);
            const topAttackPoints = getSortedPlayers(thisYearData, '공격P').slice(0, 5);
            const topMatches = getSortedPlayers(thisYearData, '경기수').slice(0, 5);
        
            const tableBody = document.querySelector('tbody');
            tableBody.innerHTML = ''; // 기존 테이블 초기화
        
            let rank = 1;
            for (let i = 0; i < 5; i++) {
                if (i > 0 && topGoals[i]?.득점 !== topGoals[i - 1]?.득점) {
                    rank = i + 1;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rank}. ${topGoals[i]?.이름 || '-'}</td><td>${topGoals[i]?.득점 || '-'} 골</td>
                    <td>${rank}. ${topAssists[i]?.이름 || '-'}</td><td>${topAssists[i]?.도움 || '-'} 도움</td>
                    <td>${rank}. ${topAttackPoints[i]?.이름 || '-'}</td><td>${topAttackPoints[i]?.공격P || '-'} P</td>
                    <td>${rank}. ${topMatches[i]?.이름 || '-'}</td><td>${topMatches[i]?.경기수 || '-'} 경기</td>
                `;
        
                tableBody.appendChild(row);
            }
        }

        // 동률 처리 함수
        function getSortedPlayers(playerRecord, key) {
            return [...playerRecord].sort((a, b) => {
                if (b[key] !== a[key]) return b[key] - a[key]; // 주된 키로 정렬
                if (b['도움'] !== a['도움']) return b['도움'] - a['도움']; // 동률이면 도움 기준 정렬
                if (b['공격P'] !== a['공격P']) return b['공격P'] - a['공격P']; // 그래도 동률이면 공격포인트 기준 정렬
                return b['경기수'] - a['경기수']; // 최종적으로 경기수 기준 정렬
            });
        }

        // 최근 갱신 시간 표시
        function updateTimeInfo() {
            const lastUpdatedTime = new Date(lastUpdated);
            document.getElementById('lastUpdate').innerText = `최근 데이터 갱신 시간: ${formatTime(lastUpdatedTime)}`;
        }

        window.onload = function() {
            fetchData(); // 페이지 로드 시 데이터 자동 갱신
        };
    </script>
</head>
<body>
    <h1>메인 페이지에 오신 것을 환영합니다!</h1>
    <!-- 네비게이션 바 -->
    <nav>
        <ul style="list-style: none; display: flex; justify-content: space-around; padding: 0;">
            <li><a href="MatchRecord.html">최근 전적</a></li>
            <li><a href="PlayerData.html">선수 데이터</a></li>
            <li><a href="PlayerRecord.html">선수기록</a></li>
        </ul>
    </nav>

    <!-- 상태 및 시간 정보 표시 -->
    <div id="status">데이터 상태: 로딩 중...</div>
    <div id="lastUpdate"></div>

    <!-- 선수 기록 테이블 -->
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th colspan="2"><span class="top-label">최다 득점 TOP</span><span class="top-number">5</span></th>
                    <th colspan="2"><span class="top-label">최다 도움 TOP</span><span class="top-number">5</span></th>
                    <th colspan="2"><span class="top-label">최다 공격포인트 TOP</span><span class="top-number">5</span></th>
                    <th colspan="2"><span class="top-label">최다 출전수 TOP</span><span class="top-number">5</span></th>
                </tr>
            </thead>
            <tbody>
                <!-- 동적으로 생성될 내용 -->
            </tbody>
        </table>
    </div>
</body>
</html>
